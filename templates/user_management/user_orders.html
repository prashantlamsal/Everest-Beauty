{% extends 'base.html' %}
{% load static %}

{% block title %}My Orders - Everest Beauty{% endblock %}

{% block extra_css %}
<style>
    .orders-hero {
        background: linear-gradient(135deg, #0ea5e9, #f43f5e);
        color: #fff;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
    }

    .orders-hero h1 {
        font-weight: 800;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .orders-hero p {
        margin: 6px 0 0;
        opacity: 0.9;
    }

    .order-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 18px;
    }

    .filter-chip {
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
        padding: 10px 14px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.04);
    }

    .filter-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
    }

    .filter-chip.active {
        background: #0ea5e9;
        color: #fff;
        border-color: #0ea5e9;
    }

    .order-card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 18px;
        margin-bottom: 16px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.08);
    }

    .order-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .order-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 18px;
        color: #6b7280;
        font-weight: 600;
    }

    .status-pill {
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 700;
        text-transform: capitalize;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-pill i { font-size: 0.95rem; }

    .status-delivered { background: #ecfdf3; color: #047857; }
    .status-pending { background: #fff7ed; color: #c2410c; }
    .status-cancelled { background: #fef2f2; color: #b91c1c; }
    .status-processing { background: #eff6ff; color: #1d4ed8; }
    .status-default { background: #f3f4f6; color: #111827; }

    .order-body {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-top: 14px;
        align-items: start;
    }

    .metric {
        display: flex;
        flex-direction: column;
        gap: 4px;
        color: #6b7280;
        font-weight: 600;
    }

    .metric strong { color: #0f172a; font-size: 1.05rem; }

    .order-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn-soft {
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
        padding: 10px 14px;
        border-radius: 12px;
        font-weight: 700;
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-soft:hover {
        color: #0ea5e9;
        border-color: #0ea5e9;
        transform: translateY(-1px);
    }

    .empty-state {
        background: #fff;
        border: 1px dashed #e5e7eb;
        border-radius: 16px;
        padding: 48px 24px;
        text-align: center;
        color: #6b7280;
    }

    .empty-state h3 { color: #0f172a; font-weight: 800; }

    .empty-state .btn-primary {
        background: linear-gradient(135deg, #0ea5e9, #2563eb);
        border: none;
        padding: 12px 22px;
        border-radius: 12px;
        font-weight: 700;
    }

    @media (max-width: 768px) {
        .orders-hero { flex-direction: column; align-items: flex-start; }
        .order-top { flex-direction: column; align-items: flex-start; }
        .order-actions { width: 100%; justify-content: flex-start; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="orders-hero">
        <div>
            <p class="mb-1" style="opacity:0.85; font-weight:600; letter-spacing:0.5px;">My Space</p>
            <h1 class="mb-1">Orders & Tracking</h1>
            <p>Track your beauty hauls, manage statuses, and reopen details in seconds.</p>
        </div>
        <a href="{% url 'dashboard:home' %}" class="btn btn-light" style="font-weight:700; border-radius:12px; padding:10px 16px;">
            <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
        </a>
    </div>

    {% if orders %}
        <div class="order-filters">
            <button class="filter-chip active" data-status="all">All</button>
            <button class="filter-chip" data-status="pending">Pending</button>
            <button class="filter-chip" data-status="processing">Processing</button>
            <button class="filter-chip" data-status="delivered">Delivered</button>
            <button class="filter-chip" data-status="cancelled">Cancelled</button>
        </div>

        <div id="ordersList">
            {% for order in orders %}
            <div class="order-card" data-status="{{ order.status }}">
                <div class="order-top">
                    <div>
                        <div class="order-meta">
                            <span>#{{ order.order_number }}</span>
                            <span>{{ order.created_at|date:"M d, Y" }}</span>
                            <span>{{ order.created_at|date:"h:i A" }}</span>
                        </div>
                        <div class="mt-2" style="color:#9ca3af; font-weight:600;">
                            {{ order.shipping_address|default:"Shipping address not set" }}
                        </div>
                    </div>
                    <span class="status-pill 
                        {% if order.status == 'delivered' %}status-delivered
                        {% elif order.status == 'pending' %}status-pending
                        {% elif order.status == 'cancelled' %}status-cancelled
                        {% elif order.status == 'processing' %}status-processing
                        {% else %}status-default{% endif %}">
                        <i class="fas fa-circle"></i>{{ order.get_status_display }}
                    </span>
                </div>

                <div class="order-body">
                    <div class="metric">
                        <span>Total</span>
                        <strong>Rs. {{ order.total_amount }}</strong>
                    </div>
                    <div class="metric">
                        <span>Payment</span>
                        <strong>{{ order.get_payment_status_display }}</strong>
                    </div>
                    <div class="metric">
                        <span>Items</span>
                        <strong>{{ order.items.count|default:order.items|length }}</strong>
                    </div>
                    <div class="metric">
                        <span>Expected</span>
                        <strong>{% if order.expected_delivery %}{{ order.expected_delivery|date:"M d" }}{% else %}--{% endif %}</strong>
                    </div>
                    <div class="order-actions">
                        <a href="{% url 'order_management:order_detail' order.id %}" class="btn-soft">
                            <i class="fas fa-eye"></i> View details
                        </a>
                        {% if order.status == 'delivered' %}
                        <a href="{% url 'review_system:review_list' %}" class="btn-soft">
                            <i class="fas fa-pen"></i> Review products
                        </a>
                        {% elif order.status == 'pending' or order.status == 'confirmed' or order.status == 'processing' %}
                        <form method="POST" action="{% url 'user_management:cancel_order' order.id %}" style="display:inline;" onsubmit="event.preventDefault(); showConfirm('Cancel order #{{ order.order_number }}? This cannot be undone.', 'Cancel Order').then(ok => { if(ok) event.target.submit(); });">
                            {% csrf_token %}
                            <button type="submit" class="btn-soft" style="background:#fef2f2; border-color:#fecdd3; color:#b91c1c;">
                                <i class="fas fa-times-circle"></i> Cancel order
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-3" style="border-top:1px solid #e5e7eb; padding-top:12px; display:grid; gap:8px;">
                    {% for item in order.items.all %}
                    <div style="display:grid; grid-template-columns:52px 1fr auto; gap:10px; align-items:center;">
                        <div class="thumb" style="width:52px; height:52px; border-radius:12px; background:linear-gradient(135deg,#e5e7eb,#f3f4f6); display:grid; place-items:center; font-weight:800; color:#6b7280;">{{ item.product_name|first|upper }}</div>
                        <div>
                            <div style="font-weight:700; color:#0f172a;">{{ item.product_name }}</div>
                            <div class="text-muted" style="font-weight:600;">Qty {{ item.quantity }} â€¢ Rs. {{ item.unit_price }}</div>
                        </div>
                        <div style="font-weight:800; color:#f43f5e;">Rs. {{ item.total_price }}</div>
                    </div>
                    {% empty %}
                    <div class="text-muted">No line items recorded.</div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-shopping-bag fa-3x mb-3"></i>
            <h3>Nothing ordered yet</h3>
            <p>When you place your first order, it will appear here for quick tracking.</p>
            <a href="{% url 'dashboard:home' %}" class="btn btn-primary mt-2">
                Start shopping
            </a>
        </div>
    {% endif %}
</div>

<script>
    (function() {
        const chips = document.querySelectorAll('.filter-chip');
        const orders = document.querySelectorAll('.order-card');
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                chips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                const status = chip.getAttribute('data-status');
                orders.forEach(card => {
                    const cardStatus = card.getAttribute('data-status');
                    const matches = status === 'all' || cardStatus === status;
                    card.style.display = matches ? '' : 'none';
                });
            });
        });
    })();
</script>
{% endblock %}
