{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Everest Beauty{% endblock %}

{% block extra_css %}
<style>
    .cart-container {
        background: var(--white);
        border-radius: 24px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        border: 1px solid rgba(233, 30, 99, 0.08);
    }
    
    .cart-header {
        background: var(--gradient-primary);
        color: var(--white);
        padding: 28px 30px;
        text-align: center;
    }
    
    .cart-header h1 {
        margin: 0;
        font-size: 2.2rem;
        font-weight: 700;
    }
    
    .cart-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .cart-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        padding: 22px 28px;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
    }
    
    .cart-item:hover {
        background: #f8f9fa;
    }
    
    .cart-item:last-child {
        border-bottom: none;
    }
    
    .item-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 15px;
        margin-right: 20px;
        box-shadow: var(--shadow);
    }
    
    .item-details {
        flex: 1;
        min-width: 0;
    }
    
    .item-name {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 5px;
    }
    
    .item-brand {
        color: var(--secondary-color);
        font-size: 1rem;
        margin-bottom: 10px;
    }
    
    .item-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .item-original-price {
        color: #6c757d;
        text-decoration: line-through;
        margin-left: 10px;
        font-size: 1rem;
    }
    
    .item-quantity {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0 18px;
    }
    
    .quantity-btn {
        width: 35px;
        height: 35px;
        border: 2px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        border-radius: 50%;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .quantity-btn:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .quantity-input {
        width: 50px;
        height: 35px;
        text-align: center;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
    }
    
    .item-total {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0 18px;
        min-width: 100px;
        text-align: right;
    }
    
    .remove-btn {
        background: none;
        border: none;
        color: #dc3545;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .remove-btn:hover {
        background: #dc3545;
        color: white;
    }
    
    .cart-summary {
        background: var(--rare-cream);
        padding: 26px 30px 30px;
        border-radius: 0 0 24px 24px;
        border-top: 1px solid rgba(0, 0, 0, 0.03);
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }
    
    .summary-row.total {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        border-top: 2px solid #e9ecef;
        padding-top: 15px;
        margin-top: 20px;
    }
    
    .checkout-btn {
        width: 100%;
        padding: 18px;
        background: var(--gradient-primary);
        border: none;
        color: #fff;
        border-radius: 18px;
        font-size: 1.05rem;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow);
        margin-top: 20px;
        letter-spacing: 0.5px;
    }
    .checkout-btn:hover {
        background: linear-gradient(135deg, #c2185b 0%, #e91e63 100%);
        color: #fff;
        transform: translateY(-2px) scale(1.02);
        box-shadow: var(--shadow-xl);
    }
    .checkout-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .empty-cart {
        text-align: center;
        padding: 70px 30px 80px;
        background: var(--gradient-soft);
    }
    
    .empty-cart i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 20px;
    }
    
    .empty-cart h3 {
        color: #6c757d;
        margin-bottom: 20px;
    }
    
    .continue-shopping {
        background: var(--primary-color);
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }
    
    .continue-shopping:hover {
        background: #d63384;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
    }
    
    .cart-notifications {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .notification {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        padding: 15px 20px;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary-color);
        animation: slideIn 0.3s ease;
    }
    
    .notification.success {
        border-left-color: #28a745;
    }
    
    .notification.error {
        border-left-color: #dc3545;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive cart layout */
    @media (max-width: 992px) {
        .cart-item {
            align-items: flex-start;
        }

        .item-quantity {
            margin: 0 8px;
        }

        .item-total {
            margin: 0 8px;
        }
    }

    @media (max-width: 768px) {
        .cart-container {
            border-radius: 20px;
        }

        .cart-item {
            flex-direction: column;
            align-items: flex-start;
            padding: 18px 20px;
        }

        .item-image {
            margin-right: 0;
            margin-bottom: 12px;
        }

        .item-quantity {
            margin: 10px 0 0;
        }

        .item-total {
            margin: 10px 0 0;
            text-align: left;
        }

        .cart-summary {
            padding: 20px 18px 24px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
        </ol>
    </nav>

    {% if cart_items %}
    <div class="cart-container">
        <div class="cart-header">
            <h1><i class="fas fa-shopping-cart"></i> Your Shopping Cart</h1>
            <p>{{ cart.total_items }} item{{ cart.total_items|pluralize }} • Total: Rs. {{ cart.total_amount }}</p>
        </div>

        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item" id="cart-item-{{ item.id }}">
                <img src="{{ item.product.main_image.url }}" alt="{{ item.product.name }}" class="item-image">
                
                <div class="item-details">
                    <h5 class="item-name">{{ item.product.name }}</h5>
                    <p class="item-brand">by {{ item.product.brand.name }}</p>
                    <div class="item-price">
                        Rs. {{ item.product.current_price }}
                        {% if item.product.original_price > item.product.current_price %}
                            <span class="item-original-price">Rs. {{ item.product.original_price }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="item-quantity">
                    <button class="quantity-btn" onclick="updateQuantity({{ item.id }}, -1)" {% if item.quantity <= 1 %}disabled{% endif %}>
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" max="10" 
                           onchange="updateQuantity({{ item.id }}, 0, this.value)">
                    <button class="quantity-btn" onclick="updateQuantity({{ item.id }}, 1)" {% if item.quantity >= 10 %}disabled{% endif %}>
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <div class="item-total" id="item-total-{{ item.id }}">
                    Rs. {{ item.total_price }}
                </div>

                <button class="remove-btn" onclick="removeFromCart({{ item.id }})" title="Remove item">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>

        <div class="cart-summary">
            <div class="summary-row">
                <span>Subtotal:</span>
                <span id="cart-subtotal">Rs. {{ cart.subtotal }}</span>
            </div>
            <div class="summary-row">
                <span>Delivery Fee:</span>
                <span id="delivery-fee-display">{% if cart.subtotal >= 1000 %}Free{% else %}Rs. 100{% endif %}</span>
            </div>
            <div class="summary-row" id="free-delivery-msg" {% if cart.subtotal >= 1000 %}style="display:none;"{% endif %}>
                <span>Free delivery on orders above Rs. 1000</span>
                <span class="text-success">Save Rs. 100</span>
            </div>
            <div class="summary-row total">
                <span>Total:</span>
                <span id="cart-total">Rs. {{ cart.total_amount }}</span>
            </div>

            <button class="checkout-btn" onclick="proceedToCheckout()">
                <i class="fas fa-credit-card"></i> Proceed to Checkout
            </button>
        </div>
    </div>
    {% else %}
    <div class="cart-container">
        <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <h3>Your cart is empty</h3>
            <p>Looks like you haven't added any products to your cart yet.</p>
            <a href="{% url 'dashboard:home' %}" class="continue-shopping">
                <i class="fas fa-arrow-left"></i> Continue Shopping
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Notifications -->
<div class="cart-notifications" id="notifications"></div>
{% endblock %}

{% block extra_js %}
<script>
    // CSRF Token utility function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateQuantity(itemId, change, newValue = null) {
        const itemElement = document.getElementById(`cart-item-${itemId}`);
        const quantityInput = itemElement.querySelector('.quantity-input');
        const minusBtn = itemElement.querySelector('.quantity-btn:first-child');
        const plusBtn = itemElement.querySelector('.quantity-btn:last-child');
        
        let quantity;
        if (newValue !== null) {
            quantity = parseInt(newValue);
        } else {
            quantity = parseInt(quantityInput.value) + change;
        }
        
        // Validate quantity
        if (quantity < 1) quantity = 1;
        if (quantity > 10) quantity = 10;
        
        // Update input value
        quantityInput.value = quantity;
        
        // Update button states
        minusBtn.disabled = quantity <= 1;
        plusBtn.disabled = quantity >= 10;
        
        // Send update to server
        fetch('/api/cart/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Convert values to numbers
                const itemTotal = parseFloat(data.item_total);
                const cartTotal = parseFloat(data.cart_total);
                const subtotal = parseFloat(data.subtotal);
                
                // Update item total with Rs. formatting
                document.getElementById(`item-total-${itemId}`).textContent = `Rs. ${itemTotal.toFixed(2)}`;
                
                // Update cart summary
                updateCartSummary(cartTotal, subtotal);
                
                // Update cart count in header
                if (typeof updateCartCount === 'function') {
                    updateCartCount();
                }
                
                showNotification('Quantity updated successfully!', 'success');
            } else {
                showNotification(data.message || 'Failed to update quantity', 'error');
                // Revert quantity input
                quantityInput.value = data.original_quantity || 1;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to update quantity', 'error');
        });
    }
    
    async function removeFromCart(itemId) {
        const ok = await showConfirm('Remove this item from your cart?', 'Remove Item');
        if (!ok) return;
        
        const itemElement = document.getElementById(`cart-item-${itemId}`);
        itemElement.classList.add('loading');
        
        fetch('/api/cart/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_id: itemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove item from DOM
                itemElement.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    itemElement.remove();
                    
                    // Check if cart is empty
                    const remainingItems = document.querySelectorAll('.cart-item');
                    if (remainingItems.length === 0) {
                        location.reload(); // Reload to show empty cart
                    }
                }, 300);
                
                // Update cart summary with proper numeric values
                const cartTotal = parseFloat(data.cart_total);
                const subtotal = parseFloat(data.subtotal);
                updateCartSummary(cartTotal, subtotal);
                
                // Update cart count in header
                if (typeof updateCartCount === 'function') {
                    updateCartCount();
                }
                
                showNotification('Item removed from cart successfully!', 'success');
            } else {
                showNotification(data.message || 'Failed to remove item', 'error');
                itemElement.classList.remove('loading');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to remove item', 'error');
            itemElement.classList.remove('loading');
        });
    }
    
    function updateCartSummary(cartTotal, subtotal) {
        // Ensure values are numbers
        cartTotal = parseFloat(cartTotal) || 0;
        subtotal = parseFloat(subtotal) || 0;
        
        // Calculate delivery fee based on subtotal
        const deliveryFee = subtotal >= 1000 ? 0 : 100;
        const totalWithDelivery = subtotal + deliveryFee;
        
        console.log('Updating cart summary:', { subtotal, deliveryFee, totalWithDelivery });
        
        // Update cart header
        const cartHeader = document.querySelector('.cart-header p');
        const cartItems = document.querySelectorAll('.cart-item');
        if (cartHeader) {
            cartHeader.textContent = `${cartItems.length} item${cartItems.length !== 1 ? 's' : ''} • Total: Rs. ${totalWithDelivery.toFixed(2)}`;
        }
        
        // Update subtotal
        const cartSubtotal = document.getElementById('cart-subtotal');
        if (cartSubtotal) {
            cartSubtotal.textContent = `Rs. ${subtotal.toFixed(2)}`;
            console.log('Updated subtotal to:', `Rs. ${subtotal.toFixed(2)}`);
        }
        
        // Update delivery fee
        const deliveryFeeDisplay = document.getElementById('delivery-fee-display');
        if (deliveryFeeDisplay) {
            deliveryFeeDisplay.textContent = deliveryFee === 0 ? 'Free' : `Rs. ${deliveryFee}`;
            console.log('Updated delivery fee to:', deliveryFeeDisplay.textContent);
        }
        
        // Update free delivery message visibility
        const freeLiveryMsg = document.getElementById('free-delivery-msg');
        if (freeLiveryMsg) {
            freeLiveryMsg.style.display = subtotal >= 1000 ? 'none' : 'flex';
        }
        
        // Update grand total (subtotal + delivery fee)
        const cartTotalElement = document.getElementById('cart-total');
        if (cartTotalElement) {
            cartTotalElement.textContent = `Rs. ${totalWithDelivery.toFixed(2)}`;
            console.log('Updated grand total to:', `Rs. ${totalWithDelivery.toFixed(2)}`);
        }
    }
    
    function proceedToCheckout() {
        const checkoutBtn = document.querySelector('.checkout-btn');
        checkoutBtn.disabled = true;
        checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Redirect to checkout page
        setTimeout(() => {
            window.location.href = '/orders/checkout/';
        }, 1000);
    }
    
    function showNotification(message, type = 'info') {
        const notifications = document.getElementById('notifications');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            ${message}
        `;
        
        notifications.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    // Add slideOut animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideOut {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
